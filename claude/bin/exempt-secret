#!/bin/bash
#ddev-generated
#
# exempt-secret - Grant temporary session-scoped access to a secret file
#
# Usage: exempt-secret <file_path_or_basename> [file2] ...
#
# Called by Claude after user approval. Adds paths to the session override
# file so secret-check.sh allows access. Session-scoped only â€” lost on
# container restart. This is intentional: prompt injection can't create
# permanent security holes.

set -euo pipefail

LOG_PREFIX="[ddev-claude]"
log() { echo "$LOG_PREFIX $*"; }
error() { echo "$LOG_PREFIX ERROR: $*" >&2; }

OVERRIDE_FILE="/tmp/ddev-claude-secret-override"

if [[ $# -eq 0 ]]; then
    error "Usage: exempt-secret <file_path_or_basename> [file2] ..."
    exit 1
fi

# Create override file if it doesn't exist
touch "$OVERRIDE_FILE"

for entry in "$@"; do
    # Don't add duplicates
    if grep -qFx "$entry" "$OVERRIDE_FILE" 2>/dev/null; then
        log "Already exempted: $entry"
        continue
    fi

    echo "$entry" >> "$OVERRIDE_FILE"
    log "Granted session access to: $entry"
done

log "Done. Secret file(s) exempted for this session only."
