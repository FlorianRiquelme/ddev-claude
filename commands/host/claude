#!/bin/bash
## Description: Run Claude CLI with firewall protection
## Usage: claude [flags] [args]
## Example: "ddev claude --help"
## Example: "ddev claude --dangerously-skip-permissions"
## Flags: [{"Name":"no-firewall","Usage":"Disable firewall (for building initial whitelist)"}]

# This command runs on host and executes in claude container via ddev exec

if [[ "$1" == "--no-firewall" ]]; then
    shift
    echo "[ddev-claude] Firewall disabled for this session"
    echo "[ddev-claude] Logging network traffic to build whitelist..."

    # Start traffic logging
    LOGGER_PID=$(ddev exec -s claude /var/www/html/.ddev/claude/scripts/log-network-traffic.sh start)

    # Disable firewall and run claude
    ddev exec -s claude bash -c "iptables -F OUTPUT && iptables -P OUTPUT ACCEPT && claude \"\$@\"" -- "$@"
    EXIT_CODE=$?

    # Stop logging and save results
    ddev exec -s claude /var/www/html/.ddev/claude/scripts/log-network-traffic.sh stop "$LOGGER_PID"

    # Show accessed domains
    echo ""
    echo "[ddev-claude] Domains accessed during this session:"
    ddev exec -s claude cat /tmp/ddev-claude-accessed.log 2>/dev/null || echo "(none captured)"
    echo ""
    echo "[ddev-claude] Run 'ddev claude:whitelist' to add these to your whitelist"

    exit $EXIT_CODE
else
    # Normal mode: firewall active
    ddev exec -s claude claude "$@"
fi
