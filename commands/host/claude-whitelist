#!/bin/bash
## Description: Manage firewall whitelist - view blocked domains and add to whitelist
## Usage: claude-whitelist
## Example: "ddev claude:whitelist"

# This command runs on host and uses gum for interactive UI

set -euo pipefail

GLOBAL_CONFIG="$HOME/.ddev/ddev-claude/whitelist.json"
PROJECT_CONFIG=".ddev/ddev-claude/whitelist.json"

echo "[ddev-claude] Whitelist Manager"
echo ""

# Initialize config files if they don't exist
for config in "$GLOBAL_CONFIG" "$PROJECT_CONFIG"; do
    if [[ ! -f "$config" ]]; then
        mkdir -p "$(dirname "$config")"
        echo '[]' > "$config"
        echo "Created: $config"
    fi
done

# Get blocked domains from container logs
echo "Fetching blocked domains from last session..."
blocked=$(ddev exec -s claude bash -c "dmesg 2>/dev/null | grep '\[FIREWALL-BLOCK\]' | grep -oP 'DST=\K[0-9.]+' | sort -u" 2>/dev/null || echo "")

if [[ -z "$blocked" ]]; then
    echo "No blocked domains found in current session."
    echo ""
    echo "Current whitelisted domains:"
    ddev exec -s claude cat /var/www/html/.ddev/claude/config/default-whitelist.json 2>/dev/null | jq -r '.[]' || echo "(none)"
    exit 0
fi

# Count blocked IPs
blocked_count=$(echo "$blocked" | wc -l | tr -d ' ')
echo "Found $blocked_count blocked IPs"
echo ""

# For now, show the blocked IPs (Phase 2-04 will add interactive gum selection)
echo "Blocked IPs (add domains via /whitelist skill in Claude):"
echo "$blocked"
echo ""
echo "Tip: Use the /whitelist skill in Claude to add domains interactively."
