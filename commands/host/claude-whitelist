#!/bin/bash
#ddev-generated
## Description: Manage firewall whitelist - view blocked domains and add to whitelist
## Usage: claude-whitelist
## Example: "ddev claude:whitelist"

set -euo pipefail

GLOBAL_CONFIG="$HOME/.ddev/ddev-claude/whitelist.json"
PROJECT_CONFIG=".ddev/ddev-claude/whitelist.json"

echo ""
echo "=== ddev-claude Whitelist Manager ==="
echo ""

# Initialize config files if they don't exist
for config in "$GLOBAL_CONFIG" "$PROJECT_CONFIG"; do
    if [[ ! -f "$config" ]]; then
        mkdir -p "$(dirname "$config")"
        echo '[]' > "$config"
    fi
done

# Get blocked domains from container
echo "Scanning for blocked requests..."
blocked=$(ddev exec -s claude "${DDEV_APPROOT}/.ddev/claude/scripts/parse-blocked-domains.sh" 2>/dev/null || echo "")

# Get accessed domains from no-firewall sessions
accessed=$(ddev exec -s claude cat /tmp/ddev-claude-accessed.log 2>/dev/null || echo "")

# Combine and deduplicate
all_domains=$(echo -e "${blocked}\n${accessed}" | grep -v '^$' | sort -u)

if [[ -z "$all_domains" ]]; then
    echo "No blocked or accessed domains found."
    echo ""
    echo "Current whitelist (merged):"
    ddev exec -s claude "${DDEV_APPROOT}/.ddev/claude/scripts/merge-whitelist.sh" 2>/dev/null || echo "(empty)"
    echo ""
    exit 0
fi

# Filter out IPs without reverse DNS (keep only actual domains)
domains=$(echo "$all_domains" | grep -v "(no reverse DNS)" || echo "")
ips_only=$(echo "$all_domains" | grep "(no reverse DNS)" || echo "")

# Count sources
blocked_count=$(printf '%s\n' "$blocked" | awk 'NF{c++} END{print c+0}')
accessed_count=$(printf '%s\n' "$accessed" | awk 'NF{c++} END{print c+0}')

echo ""
if [[ "$blocked_count" -gt 0 ]]; then
    echo "Blocked by firewall: $blocked_count domain(s)"
fi
if [[ "$accessed_count" -gt 0 ]]; then
    echo "Accessed in no-firewall mode: $accessed_count domain(s)"
fi

if [[ -n "$ips_only" ]]; then
    echo ""
    echo "IPs without reverse DNS (use /whitelist skill in Claude to identify):"
    echo "$ips_only"
fi

if [[ -z "$domains" ]]; then
    echo ""
    echo "No domain names found. Use the /whitelist skill in Claude for better domain detection."
    exit 0
fi

echo ""
echo "Found domains:"
echo "$domains"
echo ""

# Check if gum is available (it's in the container)
if ! ddev exec -s claude which gum >/dev/null 2>&1; then
    echo "Tip: Add domains using /whitelist skill in Claude for interactive selection."
    exit 0
fi

# Interactive selection with gum (runs in container)
echo "Select domains to whitelist (space to select, enter to confirm):"
selected=$(echo "$domains" | ddev exec -s claude gum choose --no-limit --header "Select domains:" 2>/dev/null || echo "")

if [[ -z "$selected" ]]; then
    echo "No domains selected."
    exit 0
fi

# Choose target config
echo ""
target=$(ddev exec -s claude gum choose "Global (~/.ddev/ddev-claude/whitelist.json)" "Project (.ddev/ddev-claude/whitelist.json)" 2>/dev/null || echo "Global")

case "$target" in
    Global*)
        config_file="$GLOBAL_CONFIG"
        ;;
    Project*)
        config_file="$PROJECT_CONFIG"
        ;;
    *)
        config_file="$PROJECT_CONFIG"
        ;;
esac

# Add domains to config
echo ""
echo "Adding to: $config_file"

# Read existing, add new, deduplicate
existing=$(jq -r '.[]' "$config_file" 2>/dev/null || echo "")
combined=$(echo -e "$existing\n$selected" | sort -u | grep -v '^$')

# Write back as JSON array
echo "$combined" | jq -R -s 'split("\n") | map(select(length > 0))' > "$config_file"

echo "Added $(echo "$selected" | wc -l | tr -d ' ') domain(s)"
echo ""
echo "Hot reload will apply changes automatically (2-3 seconds)."
