name: ddev-claude
ddev_version_constraint: '>= v1.24.10'

# Architecture: Dedicated claude container with firewalled network
# Web container remains unchanged

pre_install_actions:
  - |
    #ddev-description:Validating Docker supports NET_ADMIN capability
    docker run --rm --cap-add=NET_ADMIN alpine sh -c 'exit 0' || (echo "ERROR: Docker does not support NET_ADMIN capability. This addon requires NET_ADMIN for iptables firewall management." && exit 1)
  - |
    #ddev-description:Ensuring Claude CLI state file exists for bind mount
    [ -f ~/.claude.json ] || echo '{}' > ~/.claude.json
  - |
    #ddev-description:Cleaning up previous addon files for upgrade
    rm -rf .ddev/claude .ddev/commands/host/claude .ddev/commands/host/claude-whitelist

project_files:
  - claude/
  - docker-compose.claude.yaml
  - commands/host/

post_install_actions:
  - |
    #ddev-description:Copying Claude skills to project
    mkdir -p .ddev/ddev-claude/skills
    cp -r .ddev/claude/skills/* .ddev/ddev-claude/skills/ 2>/dev/null || true
  - |
    #ddev-description:Making firewall scripts executable
    chmod +x .ddev/claude/*.sh .ddev/claude/hooks/*.sh .ddev/claude/bin/* .ddev/claude/scripts/*.sh 2>/dev/null || true

removal_actions:
  - |
    #ddev-description:Restoring Claude Code settings (removing hooks)
    if [ -f ~/.claude/settings.json.ddev-backup ]; then
      cp ~/.claude/settings.json.ddev-backup ~/.claude/settings.json
      rm -f ~/.claude/settings.json.ddev-backup
    elif [ -f ~/.claude/settings.json ]; then
      # Remove our hook entry even without backup
      jq 'if .hooks?.PreToolUse then .hooks.PreToolUse |= map(select(.hooks | all(.command != "/opt/ddev-claude/hooks/url-check.sh"))) | if .hooks.PreToolUse == [] then del(.hooks.PreToolUse) else . end | if .hooks == {} then del(.hooks) else . end else . end' ~/.claude/settings.json > /tmp/ddev-claude-settings-clean.json && mv /tmp/ddev-claude-settings-clean.json ~/.claude/settings.json || true
    fi
  - |
    #ddev-description:Removing addon files
    rm -rf .ddev/claude .ddev/docker-compose.claude.yaml
