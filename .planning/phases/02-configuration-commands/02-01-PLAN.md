---
phase: 02-configuration-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - claude/Dockerfile.claude
  - claude/scripts/merge-whitelist.sh
  - claude/config/default-whitelist.json
  - claude/config/stack-templates/laravel.json
  - claude/config/stack-templates/npm.json
autonomous: true

must_haves:
  truths:
    - "jq, inotify-tools, and gum are installed in claude container"
    - "Default whitelist includes Claude API, GitHub, Composer, npm domains"
    - "Stack templates exist for Laravel and npm projects"
    - "Merge script combines global and project whitelists correctly"
  artifacts:
    - path: "claude/Dockerfile.claude"
      provides: "Container with jq, inotify-tools, gum installed"
      contains: "apt-get install.*jq.*inotify-tools"
    - path: "claude/scripts/merge-whitelist.sh"
      provides: "Whitelist merge logic"
      exports: ["merged JSON to stdout"]
    - path: "claude/config/default-whitelist.json"
      provides: "Default domains for Claude development"
      contains: "api.anthropic.com"
    - path: "claude/config/stack-templates/laravel.json"
      provides: "Laravel-specific domains"
      contains: "packagist.org"
    - path: "claude/config/stack-templates/npm.json"
      provides: "npm-specific domains"
      contains: "registry.npmjs.org"
  key_links:
    - from: "claude/scripts/merge-whitelist.sh"
      to: "jq"
      via: "JSON merging with jq"
      pattern: "jq.*add.*unique"
---

<objective>
Configuration infrastructure for JSON-based whitelist management

Purpose: Establish the foundation for user-configurable whitelists by updating the container with required tools (jq, inotify-tools, gum) and creating the merge logic that combines global and project configs.

Output:
- Updated Dockerfile with jq, inotify-tools, gum
- Merge script that combines whitelist.json files
- Default whitelist in JSON format
- Stack templates for Laravel and npm projects
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-configuration-commands/02-CONTEXT.md
@.planning/phases/02-configuration-commands/02-RESEARCH.md
@claude/Dockerfile.claude
@claude/whitelist-domains.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Dockerfile with configuration tools</name>
  <files>claude/Dockerfile.claude</files>
  <action>
Add jq, inotify-tools to the existing apt-get install command in the Dockerfile.

Add gum installation using the Charmbracelet APT repository:
```bash
# Add Charm APT repository and install gum
RUN curl -fsSL https://repo.charm.sh/apt/gpg.key | gpg --dearmor -o /usr/share/keyrings/charm.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" > /etc/apt/sources.list.d/charm.list \
    && apt-get update && apt-get install -y gum \
    && rm -rf /var/lib/apt/lists/*
```

The Dockerfile should maintain the existing layers structure and add inotify-tools, jq to the system packages layer.

Keep the #ddev-generated comment at the top.
  </action>
  <verify>
bash -n to verify Dockerfile syntax (no syntax errors in RUN commands).
Check that jq, inotify-tools, and gum installation commands are present.
  </verify>
  <done>
Dockerfile includes jq, inotify-tools in system packages and gum from Charm repo.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create whitelist merge script and default config</name>
  <files>claude/scripts/merge-whitelist.sh, claude/config/default-whitelist.json</files>
  <action>
Create the scripts directory: `claude/scripts/`

Create `claude/scripts/merge-whitelist.sh`:
- Takes two optional arguments: global config path and project config path
- Defaults to `~/.ddev/ddev-claude/whitelist.json` and `.ddev/ddev-claude/whitelist.json`
- Also reads default whitelist from `/var/www/html/.ddev/claude/config/default-whitelist.json`
- Uses jq to merge all three configs: `jq -s 'add | unique'`
- Outputs merged domains (one per line) for use by resolve-and-apply.sh
- Creates missing config files with empty array `[]`
- Validates JSON before merging, exits with error if invalid
- If a config file doesn't exist, treat as empty array

Make script executable: chmod +x

Create `claude/config/default-whitelist.json`:
```json
[
  "api.anthropic.com",
  "claude.ai",
  "statsig.anthropic.com",
  "sentry.io",
  "github.com",
  "api.github.com",
  "raw.githubusercontent.com",
  "objects.githubusercontent.com",
  "codeload.github.com",
  "registry.npmjs.org",
  "packagist.org",
  "repo.packagist.org",
  "cdn.jsdelivr.net",
  "unpkg.com"
]
```

This is the same domains from whitelist-domains.txt but in JSON format, plus statsig.anthropic.com and sentry.io for Claude telemetry.
  </action>
  <verify>
Run: `bash -n claude/scripts/merge-whitelist.sh` (no syntax errors)
Run: `jq empty < claude/config/default-whitelist.json` (valid JSON)
Run: `test -x claude/scripts/merge-whitelist.sh && echo "executable"` (executable)
  </verify>
  <done>
Merge script exists and validates JSON. Default whitelist contains Claude API, GitHub, npm, Composer domains.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create stack templates for Laravel and npm</name>
  <files>claude/config/stack-templates/laravel.json, claude/config/stack-templates/npm.json</files>
  <action>
Create the stack-templates directory: `claude/config/stack-templates/`

Create `claude/config/stack-templates/laravel.json`:
```json
[
  "packagist.org",
  "repo.packagist.org",
  "api.github.com",
  "github.com",
  "raw.githubusercontent.com"
]
```

Create `claude/config/stack-templates/npm.json`:
```json
[
  "registry.npmjs.org",
  "registry.yarnpkg.com",
  "api.github.com",
  "github.com"
]
```

These templates will be offered to users when the /whitelist skill detects a Laravel or npm project.
  </action>
  <verify>
Run: `jq empty < claude/config/stack-templates/laravel.json` (valid JSON)
Run: `jq empty < claude/config/stack-templates/npm.json` (valid JSON)
  </verify>
  <done>
Stack templates exist for Laravel and npm projects with appropriate domains.
  </done>
</task>

</tasks>

<verification>
1. Dockerfile contains jq, inotify-tools in apt-get install
2. Dockerfile contains gum installation from Charm repo
3. claude/scripts/merge-whitelist.sh exists and is executable
4. claude/config/default-whitelist.json contains Claude API domains
5. claude/config/stack-templates/laravel.json exists with packagist.org
6. claude/config/stack-templates/npm.json exists with registry.npmjs.org
7. All JSON files pass jq validation
</verification>

<success_criteria>
- Container will have jq, inotify-tools, gum when rebuilt
- Merge script can combine multiple whitelist sources
- Default whitelist covers essential Claude development domains
- Stack templates ready for framework detection
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-commands/02-01-SUMMARY.md`
</output>
