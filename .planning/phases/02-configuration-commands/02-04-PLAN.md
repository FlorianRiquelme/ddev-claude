---
phase: 02-configuration-commands
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - commands/host/claude-whitelist
  - claude/scripts/parse-blocked-domains.sh
autonomous: true

must_haves:
  truths:
    - "`ddev claude:whitelist` shows blocked domains/IPs from session"
    - "Interactive selection allows choosing domains to add"
    - "User can choose global or project config target"
    - "Selected domains are added to chosen whitelist.json"
    - "Reverse DNS lookup is best-effort (may show IPs if lookup fails)"
  artifacts:
    - path: "commands/host/claude-whitelist"
      provides: "Interactive whitelist management with gum"
      contains: "gum choose"
    - path: "claude/scripts/parse-blocked-domains.sh"
      provides: "Extract blocked domains from firewall logs"
      contains: "FIREWALL-BLOCK"
  key_links:
    - from: "commands/host/claude-whitelist"
      to: "claude/scripts/parse-blocked-domains.sh"
      via: "Calls parser via ddev exec"
      pattern: "parse-blocked-domains.sh"
    - from: "commands/host/claude-whitelist"
      to: "whitelist.json"
      via: "Writes selected domains"
      pattern: "jq.*whitelist.json"
---

<objective>
Interactive whitelist management with blocked domain detection

Purpose: Enhance the claude:whitelist command to show blocked domains from the firewall log and allow users to interactively select which ones to add to their whitelist using gum's checkbox interface.

Output:
- Script to parse blocked domains from firewall logs
- Enhanced claude:whitelist command with interactive selection
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-configuration-commands/02-CONTEXT.md
@.planning/phases/02-configuration-commands/02-RESEARCH.md
@.planning/phases/02-configuration-commands/02-02-SUMMARY.md
@.planning/phases/02-configuration-commands/02-03-SUMMARY.md
@commands/host/claude-whitelist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blocked domain parser script</name>
  <files>claude/scripts/parse-blocked-domains.sh</files>
  <action>
Create `claude/scripts/parse-blocked-domains.sh`:
```bash
#!/bin/bash
set -euo pipefail

# Parse blocked domains from iptables LOG
# Outputs unique domain/IP list, one per line

LOG_PREFIX="[ddev-claude]"

# Get blocked IPs from kernel log
blocked_ips=$(dmesg 2>/dev/null | grep '\[FIREWALL-BLOCK\]' | grep -oP 'DST=\K[0-9.]+' | sort -u)

if [[ -z "$blocked_ips" ]]; then
    exit 0  # No blocked domains, silent exit
fi

# Try reverse DNS lookup for each IP
while IFS= read -r ip; do
    # Attempt reverse DNS (with timeout)
    domain=$(dig +short -x "$ip" +time=1 +tries=1 2>/dev/null | sed 's/\.$//' | head -1)

    if [[ -n "$domain" ]]; then
        echo "$domain"
    else
        # No reverse DNS, output IP with marker
        echo "$ip (no reverse DNS)"
    fi
done <<< "$blocked_ips" | sort -u
```

Make executable: chmod +x

Key points:
- Parses dmesg for FIREWALL-BLOCK entries
- Extracts destination IPs
- Attempts reverse DNS lookup (best-effort - may fail inside firewall-restricted container)
- Falls back to showing IP if no reverse DNS
- Note: Reverse DNS is best-effort. Consider whitelisting common DNS servers if needed, or accept IP-only output for many cases.
  </action>
  <verify>
Run: `bash -n claude/scripts/parse-blocked-domains.sh` (no syntax errors)
Run: `test -x claude/scripts/parse-blocked-domains.sh && echo "executable"` (executable)
  </verify>
  <done>
Parser script extracts blocked domains from firewall logs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance claude:whitelist with interactive gum selection</name>
  <files>commands/host/claude-whitelist</files>
  <action>
Replace `commands/host/claude-whitelist` with full interactive version:
```bash
#!/bin/bash
## Description: Manage firewall whitelist - view blocked domains and add to whitelist
## Usage: claude-whitelist
## Example: "ddev claude:whitelist"

set -euo pipefail

GLOBAL_CONFIG="$HOME/.ddev/ddev-claude/whitelist.json"
PROJECT_CONFIG=".ddev/ddev-claude/whitelist.json"

echo ""
echo "=== ddev-claude Whitelist Manager ==="
echo ""

# Initialize config files if they don't exist
for config in "$GLOBAL_CONFIG" "$PROJECT_CONFIG"; do
    if [[ ! -f "$config" ]]; then
        mkdir -p "$(dirname "$config")"
        echo '[]' > "$config"
    fi
done

# Get blocked domains from container
echo "Scanning for blocked requests..."
blocked=$(ddev exec -s claude /var/www/html/.ddev/claude/scripts/parse-blocked-domains.sh 2>/dev/null || echo "")

if [[ -z "$blocked" ]]; then
    echo "No blocked domains found in current session."
    echo ""
    echo "Current whitelist (merged):"
    ddev exec -s claude /var/www/html/.ddev/claude/scripts/merge-whitelist.sh 2>/dev/null || echo "(empty)"
    echo ""
    exit 0
fi

# Filter out IPs without reverse DNS (keep only actual domains)
domains=$(echo "$blocked" | grep -v "(no reverse DNS)" || echo "")
ips_only=$(echo "$blocked" | grep "(no reverse DNS)" || echo "")

if [[ -n "$ips_only" ]]; then
    echo ""
    echo "IPs without reverse DNS (use /whitelist skill in Claude to identify):"
    echo "$ips_only"
fi

if [[ -z "$domains" ]]; then
    echo ""
    echo "No domain names found. Use the /whitelist skill in Claude for better domain detection."
    exit 0
fi

echo ""
echo "Found blocked domains:"
echo "$domains"
echo ""

# Check if gum is available (it's in the container)
if ! ddev exec -s claude which gum >/dev/null 2>&1; then
    echo "Tip: Add domains using /whitelist skill in Claude for interactive selection."
    exit 0
fi

# Interactive selection with gum (runs in container)
echo "Select domains to whitelist (space to select, enter to confirm):"
selected=$(echo "$domains" | ddev exec -s claude gum choose --no-limit --header "Select domains:" 2>/dev/null || echo "")

if [[ -z "$selected" ]]; then
    echo "No domains selected."
    exit 0
fi

# Choose target config
echo ""
target=$(ddev exec -s claude gum choose "Global (~/.ddev/ddev-claude/whitelist.json)" "Project (.ddev/ddev-claude/whitelist.json)" 2>/dev/null || echo "Global")

case "$target" in
    Global*)
        config_file="$GLOBAL_CONFIG"
        ;;
    Project*)
        config_file="$PROJECT_CONFIG"
        ;;
    *)
        config_file="$PROJECT_CONFIG"
        ;;
esac

# Add domains to config
echo ""
echo "Adding to: $config_file"

# Read existing, add new, deduplicate
existing=$(jq -r '.[]' "$config_file" 2>/dev/null || echo "")
combined=$(echo -e "$existing\n$selected" | sort -u | grep -v '^$')

# Write back as JSON array
echo "$combined" | jq -R -s 'split("\n") | map(select(length > 0))' > "$config_file"

echo "Added $(echo "$selected" | wc -l | tr -d ' ') domain(s)"
echo ""
echo "Hot reload will apply changes automatically (2-3 seconds)."
```

Make executable: chmod +x

Key points:
- Uses gum for interactive multi-select (runs in container)
- Filters out IPs without reverse DNS
- User chooses global vs project config
- Uses jq to merge and deduplicate
- Informs about hot reload
  </action>
  <verify>
Run: `bash -n commands/host/claude-whitelist` (no syntax errors)
Run: `test -x commands/host/claude-whitelist && echo "executable"` (executable)
Run: `grep -q "gum choose" commands/host/claude-whitelist && echo "has gum selection"`
  </verify>
  <done>
Interactive whitelist command with gum selection and JSON config update.
  </done>
</task>

</tasks>

<verification>
1. claude/scripts/parse-blocked-domains.sh exists and is executable
2. commands/host/claude-whitelist has gum interactive selection
3. Commands allow choosing global vs project config
4. Selected domains are written as valid JSON
5. All scripts have valid bash syntax
</verification>

<success_criteria>
- Running `ddev claude:whitelist` shows blocked domains from session
- Interactive checkboxes allow selecting multiple domains
- User can choose to add to global or project config
- Selected domains appear in whitelist.json file
- Hot reload applies changes automatically
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-commands/02-04-SUMMARY.md`
</output>
