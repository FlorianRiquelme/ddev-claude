---
phase: 02-configuration-commands
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - claude/scripts/watch-config.sh
  - claude/scripts/reload-whitelist.sh
  - claude/entrypoint.sh
autonomous: true

must_haves:
  truths:
    - "Whitelist changes reload automatically without container restart"
    - "Debounce prevents multiple reloads on rapid edits"
    - "Invalid JSON keeps previous whitelist active"
    - "Reload logs domain count after applying changes"
  artifacts:
    - path: "claude/scripts/watch-config.sh"
      provides: "inotify-based file watcher with debounce"
      contains: "inotifywait"
    - path: "claude/scripts/reload-whitelist.sh"
      provides: "Whitelist reload logic"
      contains: "ipset"
    - path: "claude/entrypoint.sh"
      provides: "Updated entrypoint that starts watcher"
      contains: "watch-config.sh"
  key_links:
    - from: "claude/scripts/watch-config.sh"
      to: "claude/scripts/reload-whitelist.sh"
      via: "Calls reload on file change"
      pattern: "reload-whitelist.sh"
    - from: "claude/entrypoint.sh"
      to: "claude/scripts/watch-config.sh"
      via: "Starts watcher in background"
      pattern: "watch-config.sh.*&"
---

<objective>
Hot reload system for whitelist configuration changes

Purpose: Allow users to edit whitelist.json files and have changes take effect immediately without restarting the container. Uses inotify for file watching with debounce to handle editor save patterns.

Output:
- File watcher script with debounce logic
- Reload script that re-applies whitelist to firewall
- Updated entrypoint that starts watcher in background
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-configuration-commands/02-CONTEXT.md
@.planning/phases/02-configuration-commands/02-RESEARCH.md
@.planning/phases/02-configuration-commands/02-01-SUMMARY.md
@claude/entrypoint.sh
@claude/resolve-and-apply.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reload whitelist script</name>
  <files>claude/scripts/reload-whitelist.sh</files>
  <action>
Create `claude/scripts/reload-whitelist.sh`:
```bash
#!/bin/bash
set -euo pipefail

LOG_PREFIX="[ddev-claude]"
SCRIPT_DIR="/var/www/html/.ddev/claude"

log() { echo "$LOG_PREFIX $*"; }
error() { echo "$LOG_PREFIX ERROR: $*" >&2; }

log "Reloading whitelist..."

# Merge all whitelist sources
merged=$("$SCRIPT_DIR/scripts/merge-whitelist.sh")

if [[ -z "$merged" ]]; then
    log "WARNING: No domains in merged whitelist"
fi

# Validate merged output (should be one domain per line)
if echo "$merged" | grep -qE '[^a-zA-Z0-9.\-*]'; then
    error "Invalid characters in merged whitelist"
    exit 1
fi

# Create temporary whitelist file for resolve-and-apply.sh
temp_whitelist=$(mktemp)
echo "$merged" > "$temp_whitelist"

# Flush existing ipset entries (keep set, just clear it)
ipset flush whitelist_ips 2>/dev/null || true

# Re-resolve and apply domains
"$SCRIPT_DIR/resolve-and-apply.sh" "$temp_whitelist"

# Cleanup
rm -f "$temp_whitelist"

# Log result
ip_count=$(ipset list whitelist_ips 2>/dev/null | grep -c "^[0-9]" || echo 0)
log "Whitelist reloaded: $ip_count IPs from $(echo "$merged" | wc -l | tr -d ' ') domains"
```

Make executable: chmod +x

Key points:
- Calls merge-whitelist.sh to get combined domains
- Flushes ipset before re-resolving (idempotent)
- Uses existing resolve-and-apply.sh for DNS resolution
- Logs domain and IP counts for visibility
  </action>
  <verify>
Run: `bash -n claude/scripts/reload-whitelist.sh` (no syntax errors)
Run: `test -x claude/scripts/reload-whitelist.sh && echo "executable"` (executable)
  </verify>
  <done>
Reload script can refresh firewall whitelist from config files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create file watcher with debounce</name>
  <files>claude/scripts/watch-config.sh</files>
  <action>
Create `claude/scripts/watch-config.sh`:
```bash
#!/bin/bash
set -euo pipefail

LOG_PREFIX="[ddev-claude-watch]"
SCRIPT_DIR="/var/www/html/.ddev/claude"
DEBOUNCE_DELAY=2  # seconds
PID_FILE="/var/run/ddev-claude-watcher.pid"

log() { echo "$LOG_PREFIX $*"; }
warn() { echo "$LOG_PREFIX WARNING: $*" >&2; }

# Check if already running
if [[ -f "$PID_FILE" ]]; then
    old_pid=$(cat "$PID_FILE")
    if kill -0 "$old_pid" 2>/dev/null; then
        log "Watcher already running (PID $old_pid)"
        exit 0
    fi
    rm -f "$PID_FILE"
fi

# Store our PID
echo $$ > "$PID_FILE"

# Cleanup on exit
cleanup() {
    rm -f "$PID_FILE"
    log "Watcher stopped"
}
trap cleanup EXIT

# Config file locations
GLOBAL_CONFIG="$HOME/.ddev/ddev-claude/whitelist.json"
PROJECT_CONFIG="/var/www/html/.ddev/ddev-claude/whitelist.json"

# Create config directories if needed
mkdir -p "$(dirname "$GLOBAL_CONFIG")" 2>/dev/null || true
mkdir -p "$(dirname "$PROJECT_CONFIG")" 2>/dev/null || true

# Create empty configs if missing
for config in "$GLOBAL_CONFIG" "$PROJECT_CONFIG"; do
    if [[ ! -f "$config" ]]; then
        echo '[]' > "$config"
        log "Created empty config: $config"
    fi
done

log "Watching config files for changes..."
log "  Global: $GLOBAL_CONFIG"
log "  Project: $PROJECT_CONFIG"

last_trigger=0

# Watch for changes (close_write and moved_to for atomic saves)
inotifywait -m -e close_write,moved_to \
    "$(dirname "$GLOBAL_CONFIG")" \
    "$(dirname "$PROJECT_CONFIG")" 2>/dev/null | \
while read -r dir action file; do
    # Only react to whitelist.json files
    [[ "$file" != "whitelist.json" ]] && continue

    now=$(date +%s)

    # Debounce: skip if within delay window
    if (( now - last_trigger < DEBOUNCE_DELAY )); then
        continue
    fi

    last_trigger=$now

    log "Config changed: $dir$file"

    # Validate JSON before reloading
    config_path="$dir$file"
    if ! jq empty < "$config_path" 2>/dev/null; then
        warn "Invalid JSON in $config_path - keeping previous whitelist"
        continue
    fi

    # Reload whitelist
    if "$SCRIPT_DIR/scripts/reload-whitelist.sh"; then
        log "Reload successful"
    else
        warn "Reload failed - firewall unchanged"
    fi
done
```

Make executable: chmod +x

Key points:
- PID file prevents multiple watchers
- Cleanup trap removes PID on exit
- Watches directories (not files) for atomic editor saves
- 2-second debounce window
- Validates JSON before reload
- Only reacts to whitelist.json files
  </action>
  <verify>
Run: `bash -n claude/scripts/watch-config.sh` (no syntax errors)
Run: `test -x claude/scripts/watch-config.sh && echo "executable"` (executable)
  </verify>
  <done>
File watcher script with debounce and JSON validation ready.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update entrypoint to start watcher and use merged config</name>
  <files>claude/entrypoint.sh</files>
  <action>
Update `claude/entrypoint.sh` to:

1. Use the merge-whitelist.sh script instead of static whitelist-domains.txt
2. Start the config watcher in background after firewall init
3. Store watcher PID for cleanup

Replace the whitelist file usage (around line 43-47) with merged config:
```bash
# 6. Get merged whitelist (default + global + project)
merged_whitelist=$("$SCRIPT_DIR/scripts/merge-whitelist.sh")
if [[ -n "$merged_whitelist" ]]; then
    temp_whitelist=$(mktemp)
    echo "$merged_whitelist" > "$temp_whitelist"
    "$SCRIPT_DIR/resolve-and-apply.sh" "$temp_whitelist"
    rm -f "$temp_whitelist"
else
    log "WARNING: No domains in merged whitelist"
fi
```

After the "Firewall initialized successfully" log, add:
```bash
# Start config file watcher in background
log "Starting config file watcher..."
"$SCRIPT_DIR/scripts/watch-config.sh" &
WATCHER_PID=$!
log "Config watcher started (PID $WATCHER_PID)"
```

Keep all existing firewall rules intact (loopback, DNS, established, whitelist, log, DROP).
  </action>
  <verify>
Run: `bash -n claude/entrypoint.sh` (no syntax errors)
Run: `grep -q "merge-whitelist.sh" claude/entrypoint.sh && echo "uses merged config"`
Run: `grep -q "watch-config.sh" claude/entrypoint.sh && echo "starts watcher"`
  </verify>
  <done>
Entrypoint uses merged whitelist and starts config watcher in background.
  </done>
</task>

</tasks>

<verification>
1. claude/scripts/reload-whitelist.sh exists and is executable
2. claude/scripts/watch-config.sh exists and is executable
3. claude/entrypoint.sh calls merge-whitelist.sh for domain resolution
4. claude/entrypoint.sh starts watch-config.sh in background
5. All scripts have valid bash syntax
</verification>

<success_criteria>
- Editing whitelist.json triggers automatic reload within 2-3 seconds
- Invalid JSON edits log warning but keep firewall working
- Container startup uses merged config (default + global + project)
- Watcher process runs in background with PID tracking
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-commands/02-03-SUMMARY.md`
</output>
