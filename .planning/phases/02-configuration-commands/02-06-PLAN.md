---
phase: 02-configuration-commands
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - claude/scripts/log-network-traffic.sh
  - commands/host/claude
  - commands/host/claude-whitelist
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "`ddev claude --no-firewall` logs all accessed domains during session"
    - "Logged domains are visible via `ddev claude:whitelist`"
    - "Users can build initial whitelist from --no-firewall session"
  artifacts:
    - path: "claude/scripts/log-network-traffic.sh"
      provides: "DNS query logging using tcpdump"
      min_lines: 30
    - path: "commands/host/claude"
      provides: "--no-firewall flag with traffic logging"
      contains: "log-network-traffic"
  key_links:
    - from: "commands/host/claude"
      to: "log-network-traffic.sh"
      via: "ddev exec call when --no-firewall"
      pattern: "log-network-traffic"
    - from: "commands/host/claude-whitelist"
      to: "/tmp/ddev-claude-accessed.log"
      via: "reads logged domains"
      pattern: "accessed.log"
---

<objective>
Implement DNS/network traffic logging when firewall is disabled with --no-firewall flag.

Purpose: When users run `ddev claude --no-firewall`, they're discovering what domains Claude needs. Currently no logging exists - users have no way to know what was accessed. This closes gap UI-02.

Output: Traffic logging script and updated command that captures accessed domains for whitelist building.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference artifacts:
- `commands/host/claude` - current command (lines 10-15 need enhancement)
- `commands/host/claude-whitelist` - reads from blocked log, needs to also read accessed log
- `claude/entrypoint.sh` - reference for log file location pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create network traffic logging script</name>
  <files>claude/scripts/log-network-traffic.sh</files>
  <action>
    Create a script that logs DNS queries during a no-firewall session using tcpdump.

    Requirements:
    - Use tcpdump to capture DNS queries (port 53) in background
    - Parse captured traffic to extract queried domain names
    - Write unique domains to `/tmp/ddev-claude-accessed.log`
    - Script should start logging, return PID for cleanup
    - Include cleanup function to stop tcpdump and finalize log

    Script structure:
    ```bash
    #!/bin/bash
    # log-network-traffic.sh - Capture accessed domains during no-firewall session

    case "$1" in
      start)
        # Start tcpdump capturing DNS queries
        # Write to temp pcap file
        # Echo PID for cleanup
        ;;
      stop)
        # Kill tcpdump by PID
        # Parse pcap file for domain names
        # Write unique domains to accessed log
        # Cleanup temp files
        ;;
    esac
    ```

    Use tcpdump with filter: `port 53`
    Parse output for DNS query names (avoid responses, just queries)

    Note: tcpdump is already available in claude container (base debian image has it or we add it)
  </action>
  <verify>
    - File exists at claude/scripts/log-network-traffic.sh
    - Script is executable
    - Has start and stop subcommands
    - Uses tcpdump for DNS capture
  </verify>
  <done>Script can start/stop DNS traffic logging and output accessed domains</done>
</task>

<task type="auto">
  <name>Task 2: Update claude command for traffic logging</name>
  <files>commands/host/claude</files>
  <action>
    Modify the --no-firewall branch to:
    1. Start traffic logging before running Claude
    2. Run Claude (existing behavior)
    3. Stop traffic logging and save results when Claude exits
    4. Display summary of accessed domains to user

    Updated flow for --no-firewall:
    ```bash
    if [[ "$1" == "--no-firewall" ]]; then
        shift
        echo "[ddev-claude] Firewall disabled for this session"
        echo "[ddev-claude] Logging network traffic to build whitelist..."

        # Start traffic logging
        LOGGER_PID=$(ddev exec -s claude /var/www/html/.ddev/claude/scripts/log-network-traffic.sh start)

        # Disable firewall and run claude
        ddev exec -s claude bash -c "iptables -F OUTPUT && iptables -P OUTPUT ACCEPT && claude \"\$@\"" -- "$@"
        EXIT_CODE=$?

        # Stop logging and show results
        ddev exec -s claude /var/www/html/.ddev/claude/scripts/log-network-traffic.sh stop "$LOGGER_PID"

        # Show accessed domains
        echo ""
        echo "[ddev-claude] Domains accessed during this session:"
        ddev exec -s claude cat /tmp/ddev-claude-accessed.log 2>/dev/null || echo "(none captured)"
        echo ""
        echo "[ddev-claude] Run 'ddev claude:whitelist' to add these to your whitelist"

        exit $EXIT_CODE
    fi
    ```

    Keep the existing else branch for normal firewall mode unchanged.
  </action>
  <verify>
    - `grep -q "log-network-traffic" commands/host/claude` returns 0
    - Script still has both --no-firewall and normal mode branches
  </verify>
  <done>--no-firewall mode now logs accessed domains and displays them after session</done>
</task>

<task type="auto">
  <name>Task 3: Update whitelist command to show accessed domains</name>
  <files>commands/host/claude-whitelist</files>
  <action>
    Enhance ddev claude:whitelist to also show domains from --no-firewall sessions.

    Current behavior: Shows blocked domains from dmesg
    New behavior: Shows BOTH blocked domains AND accessed domains from no-firewall sessions

    Add a section after getting blocked domains:
    ```bash
    # Get blocked domains (existing)
    blocked_domains=$(ddev exec -s claude /var/www/html/.ddev/claude/scripts/parse-blocked-domains.sh 2>/dev/null || true)

    # Get accessed domains from no-firewall sessions
    accessed_domains=$(ddev exec -s claude cat /tmp/ddev-claude-accessed.log 2>/dev/null || true)

    # Combine and dedupe
    all_domains=$(echo -e "${blocked_domains}\n${accessed_domains}" | grep -v '^$' | sort -u)
    ```

    Update the display to indicate source:
    - "Blocked by firewall: X domains"
    - "Accessed in no-firewall mode: Y domains"

    The gum multi-select should include domains from both sources.
  </action>
  <verify>
    - `grep -q "accessed" commands/host/claude-whitelist` returns 0
    - Script handles both blocked and accessed domain sources
  </verify>
  <done>Whitelist command shows domains from both firewall blocks and no-firewall sessions</done>
</task>

</tasks>

<verification>
1. Run `ddev claude --no-firewall --help` (quick test that exits fast)
2. Check that accessed log was created: `ddev exec -s claude ls /tmp/ddev-claude-accessed.log`
3. Run `ddev claude:whitelist` and verify it mentions accessed domains
</verification>

<success_criteria>
- --no-firewall mode starts and stops traffic logging
- Accessed domains are written to /tmp/ddev-claude-accessed.log
- User sees summary of accessed domains after session
- ddev claude:whitelist includes accessed domains in selection
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-commands/02-06-SUMMARY.md`
</output>
