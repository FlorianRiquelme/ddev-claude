---
phase: 02-configuration-commands
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - claude/scripts/format-block-message.sh
  - claude/entrypoint.sh
  - claude/skills/whitelist/SKILL.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User-friendly error message appears when firewall blocks a request"
    - "Error message hints about running ddev claude:whitelist or /whitelist"
    - "Claude skill proactively mentions how to detect blocks"
  artifacts:
    - path: "claude/scripts/format-block-message.sh"
      provides: "Human-readable block notification"
      min_lines: 20
    - path: "claude/entrypoint.sh"
      provides: "Background block monitor"
      contains: "format-block-message"
  key_links:
    - from: "claude/entrypoint.sh"
      to: "format-block-message.sh"
      via: "background dmesg watcher"
      pattern: "format-block-message"
---

<objective>
Implement user-friendly error messages when firewall blocks requests.

Purpose: Currently blocks only appear as technical `[FIREWALL-BLOCK]` entries in dmesg. Users see generic "connection refused" errors without understanding the cause. This closes gap UI-05.

Output: Block notification system that surfaces user-friendly messages with remediation hints.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference artifacts:
- `claude/entrypoint.sh` - needs to start block monitor (lines 56-59 has current LOG rule)
- `claude/skills/whitelist/SKILL.md` - needs enhancement for proactive block detection
- `claude/scripts/parse-blocked-domains.sh` - existing dmesg parsing logic to reference
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user-friendly block message formatter</name>
  <files>claude/scripts/format-block-message.sh</files>
  <action>
    Create a script that monitors dmesg for firewall blocks and outputs user-friendly messages.

    Requirements:
    - Watch dmesg for new [FIREWALL-BLOCK] entries
    - Extract destination IP and attempt reverse DNS
    - Format a clear, helpful message like:
      ```
      [ddev-claude] Network request BLOCKED
        Destination: api.example.com (1.2.3.4)

        To allow this domain:
        - Run: ddev claude:whitelist
        - Or use Claude's /whitelist skill
      ```
    - Rate limit output (don't spam for repeated blocks to same IP)
    - Run as background monitor started by entrypoint

    Script structure:
    ```bash
    #!/bin/bash
    # format-block-message.sh - User-friendly firewall block notifications

    SEEN_IPS="/tmp/ddev-claude-seen-blocks"
    touch "$SEEN_IPS"

    # Watch dmesg for new blocks
    dmesg -w 2>/dev/null | while read -r line; do
        if [[ "$line" == *"[FIREWALL-BLOCK]"* ]]; then
            # Extract DST IP
            dst_ip=$(echo "$line" | grep -oP 'DST=\K[0-9.]+')

            # Skip if already seen recently (dedup)
            if grep -q "^$dst_ip$" "$SEEN_IPS" 2>/dev/null; then
                continue
            fi
            echo "$dst_ip" >> "$SEEN_IPS"

            # Reverse DNS lookup
            domain=$(dig +short -x "$dst_ip" +time=1 +tries=1 2>/dev/null | sed 's/\.$//' | head -1)

            # Output user-friendly message
            echo ""
            echo "[ddev-claude] Network request BLOCKED"
            if [[ -n "$domain" ]]; then
                echo "  Destination: $domain ($dst_ip)"
            else
                echo "  Destination: $dst_ip (unknown domain)"
            fi
            echo ""
            echo "  To allow this domain:"
            echo "  - Run: ddev claude:whitelist"
            echo "  - Or use Claude's /whitelist skill"
            echo ""
        fi
    done
    ```

    Note: dmesg -w requires appropriate permissions (claude container runs as root, should work)
  </action>
  <verify>
    - File exists at claude/scripts/format-block-message.sh
    - Script is executable
    - Contains user-friendly message format with remediation hints
    - Includes deduplication logic
  </verify>
  <done>Block formatter produces clear, actionable messages for users</done>
</task>

<task type="auto">
  <name>Task 2: Start block monitor in entrypoint</name>
  <files>claude/entrypoint.sh</files>
  <action>
    Add block monitor startup after the firewall is initialized, before exec.

    Find the section near line 71-73 where watch-config.sh is started:
    ```bash
    # Start config file watcher in background
    log "Starting config file watcher..."
    "$SCRIPT_DIR/scripts/watch-config.sh" &
    WATCHER_PID=$!
    log "Config watcher started (PID $WATCHER_PID)"
    ```

    Add block monitor startup immediately after:
    ```bash
    # Start user-friendly block notification monitor
    log "Starting block notification monitor..."
    "$SCRIPT_DIR/scripts/format-block-message.sh" &
    BLOCK_MONITOR_PID=$!
    log "Block monitor started (PID $BLOCK_MONITOR_PID)"
    ```

    This ensures users see friendly messages when requests are blocked, not just technical dmesg entries.

    Also add a helpful log message after "Firewall initialized successfully":
    ```bash
    log "If you see 'Network request BLOCKED' messages, run 'ddev claude:whitelist' or use /whitelist skill"
    ```
  </action>
  <verify>
    - `grep -q "format-block-message" claude/entrypoint.sh` returns 0
    - `grep -q "block notification monitor" claude/entrypoint.sh` returns 0 (case insensitive)
  </verify>
  <done>Entrypoint starts block monitor alongside config watcher</done>
</task>

<task type="auto">
  <name>Task 3: Enhance /whitelist skill with block detection guidance</name>
  <files>claude/skills/whitelist/SKILL.md</files>
  <action>
    Add a section to the skill that proactively helps detect firewall blocks.

    Add near the top of the skill (after the environment information section):

    ```markdown
    ## Detecting Firewall Blocks

    When network requests fail, check if the firewall blocked them:

    1. Look for "[ddev-claude] Network request BLOCKED" messages in the terminal
    2. Or check dmesg: `dmesg | grep FIREWALL-BLOCK | tail -5`
    3. Or run: `ddev claude:whitelist` to see blocked domains interactively

    Common symptoms of firewall blocks:
    - "Connection refused" errors
    - "Network unreachable" errors
    - Timeouts to external APIs
    - Package manager failures (composer, npm)

    When you see these errors, check for blocks before troubleshooting other causes.
    ```

    Also add a proactive check suggestion:
    ```markdown
    ## Proactive Block Check

    Before attempting external requests, you can inform the user:

    "I'm about to access [domain]. If this fails, it might be blocked by the firewall.
    Check for '[ddev-claude] Network request BLOCKED' messages or run 'ddev claude:whitelist'."
    ```
  </action>
  <verify>
    - `grep -q "Detecting Firewall Blocks" claude/skills/whitelist/SKILL.md` returns 0
    - `grep -q "Network request BLOCKED" claude/skills/whitelist/SKILL.md` returns 0
    - Skill contains guidance on recognizing block symptoms
  </verify>
  <done>Skill proactively guides users on detecting and resolving firewall blocks</done>
</task>

</tasks>

<verification>
1. Check script exists and is executable: `ls -la claude/scripts/format-block-message.sh`
2. Verify entrypoint starts monitor: `grep "format-block-message" claude/entrypoint.sh`
3. Verify skill has block detection section: `grep "Detecting Firewall Blocks" claude/skills/whitelist/SKILL.md`
</verification>

<success_criteria>
- Block monitor runs in background when claude container starts
- Blocked requests produce user-friendly messages with domain/IP and remediation hints
- Messages are deduplicated (same IP doesn't spam)
- /whitelist skill explains how to detect and resolve blocks
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-commands/02-07-SUMMARY.md`
</output>
