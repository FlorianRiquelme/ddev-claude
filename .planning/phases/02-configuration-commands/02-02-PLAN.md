---
phase: 02-configuration-commands
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/web/claude
  - commands/host/claude-whitelist
autonomous: true

must_haves:
  truths:
    - "`ddev claude [args]` runs Claude CLI in claude container with firewall active"
    - "`ddev claude --no-firewall` disables firewall temporarily"
    - "`ddev claude:whitelist` command exists and runs on host"
  artifacts:
    - path: "commands/web/claude"
      provides: "DDEV command for running Claude CLI"
      contains: "ExecRaw: true"
    - path: "commands/host/claude-whitelist"
      provides: "DDEV command for whitelist management"
      contains: "Description:"
  key_links:
    - from: "commands/web/claude"
      to: "claude container"
      via: "ddev exec -s claude"
      pattern: "ddev exec.*-s claude"
---

<objective>
DDEV custom commands for running Claude and managing whitelists

Purpose: Create the user-facing commands that allow running Claude with firewall protection and managing the whitelist interactively.

Output:
- `ddev claude [args]` command that runs Claude in the claude container
- `ddev claude:whitelist` command skeleton for interactive management
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-configuration-commands/02-CONTEXT.md
@.planning/phases/02-configuration-commands/02-RESEARCH.md
@docker-compose.claude.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ddev claude command</name>
  <files>commands/web/claude</files>
  <action>
Create the commands directory structure: `commands/web/`

Create `commands/web/claude`:
```bash
#!/bin/bash
## Description: Run Claude CLI with firewall protection
## Usage: claude [flags] [args]
## Example: "ddev claude --help"
## Example: "ddev claude --dangerously-skip-permissions"
## Flags: [{"Name":"no-firewall","Usage":"Disable firewall (for building initial whitelist)"}]
## HostWorkingDir: true

# This command runs on host and executes in claude container

if [[ "$1" == "--no-firewall" ]]; then
    shift
    echo "[ddev-claude] Firewall disabled for this session"
    echo "[ddev-claude] Run 'ddev claude:whitelist' after to add accessed domains"
    # Temporarily disable firewall in container
    ddev exec -s claude bash -c "iptables -F OUTPUT && iptables -P OUTPUT ACCEPT && claude $*"
else
    # Normal mode: firewall active
    ddev exec -s claude claude "$@"
fi
```

Key points:
- HostWorkingDir: true ensures we stay in project directory
- Uses `ddev exec -s claude` to run in claude container (not web)
- --no-firewall flushes iptables rules temporarily
- Passes all arguments to claude CLI

Make executable: chmod +x
  </action>
  <verify>
Run: `bash -n commands/web/claude` (no syntax errors)
Run: `test -x commands/web/claude && echo "executable"` (executable)
Run: `head -10 commands/web/claude | grep -q "Description:" && echo "has DDEV metadata"`
  </verify>
  <done>
`ddev claude` command runs Claude in claude container with passthrough arguments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ddev claude:whitelist command skeleton</name>
  <files>commands/host/claude-whitelist</files>
  <action>
Create the commands/host directory: `commands/host/`

Create `commands/host/claude-whitelist`:
```bash
#!/bin/bash
## Description: Manage firewall whitelist - view blocked domains and add to whitelist
## Usage: claude-whitelist
## Example: "ddev claude:whitelist"

# This command runs on host and uses gum for interactive UI

set -euo pipefail

GLOBAL_CONFIG="$HOME/.ddev/ddev-claude/whitelist.json"
PROJECT_CONFIG=".ddev/ddev-claude/whitelist.json"

echo "[ddev-claude] Whitelist Manager"
echo ""

# Initialize config files if they don't exist
for config in "$GLOBAL_CONFIG" "$PROJECT_CONFIG"; do
    if [[ ! -f "$config" ]]; then
        mkdir -p "$(dirname "$config")"
        echo '[]' > "$config"
        echo "Created: $config"
    fi
done

# Get blocked domains from container logs
echo "Fetching blocked domains from last session..."
blocked=$(ddev exec -s claude bash -c "dmesg 2>/dev/null | grep '\[FIREWALL-BLOCK\]' | grep -oP 'DST=\K[0-9.]+' | sort -u" 2>/dev/null || echo "")

if [[ -z "$blocked" ]]; then
    echo "No blocked domains found in current session."
    echo ""
    echo "Current whitelisted domains:"
    ddev exec -s claude cat /var/www/html/.ddev/claude/config/default-whitelist.json 2>/dev/null | jq -r '.[]' || echo "(none)"
    exit 0
fi

# Count blocked IPs
blocked_count=$(echo "$blocked" | wc -l | tr -d ' ')
echo "Found $blocked_count blocked IPs"
echo ""

# For now, show the blocked IPs (Phase 2-04 will add interactive gum selection)
echo "Blocked IPs (add domains via /whitelist skill in Claude):"
echo "$blocked"
echo ""
echo "Tip: Use the /whitelist skill in Claude to add domains interactively."
```

This is a skeleton that will be enhanced in Plan 02-04 with gum interactive selection.

Make executable: chmod +x
  </action>
  <verify>
Run: `bash -n commands/host/claude-whitelist` (no syntax errors)
Run: `test -x commands/host/claude-whitelist && echo "executable"` (executable)
Run: `head -5 commands/host/claude-whitelist | grep -q "Description:" && echo "has DDEV metadata"`
  </verify>
  <done>
`ddev claude:whitelist` command skeleton exists and can show blocked IPs.
  </done>
</task>

</tasks>

<verification>
1. commands/web/claude exists with proper DDEV metadata
2. commands/web/claude is executable
3. commands/host/claude-whitelist exists with proper DDEV metadata
4. commands/host/claude-whitelist is executable
5. Both commands have valid bash syntax
</verification>

<success_criteria>
- `ddev claude --help` will run claude CLI help
- `ddev claude --no-firewall` will disable firewall temporarily
- `ddev claude:whitelist` will show blocked domains
</success_criteria>

<output>
After completion, create `.planning/phases/02-configuration-commands/02-02-SUMMARY.md`
</output>
