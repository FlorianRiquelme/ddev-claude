---
phase: 01-firewall-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - install.yaml
  - claude/Dockerfile.claude
  - claude/docker-compose.claude.yaml
autonomous: true

must_haves:
  truths:
    - "DDEV addon can be installed via `ddev get` without errors"
    - "Dedicated claude container is created separate from web container"
    - "Claude container has NET_ADMIN and NET_RAW capabilities"
    - "Claude container runs as root (required for iptables)"
    - "Project files mounted into claude container at /var/www/html"
    - "User's ~/.claude config directory is mounted into claude container"
    - "iptables-nft and ipset tools are available in claude container"
  artifacts:
    - path: "install.yaml"
      provides: "DDEV addon manifest"
      contains: "ddev_version_constraint"
    - path: "claude/Dockerfile.claude"
      provides: "Claude container image with dev tools and firewall tools"
      contains: "iptables"
    - path: "claude/docker-compose.claude.yaml"
      provides: "Claude service definition with capabilities and mounts"
      contains: "NET_ADMIN"
  key_links:
    - from: "install.yaml"
      to: "claude/docker-compose.claude.yaml"
      via: "project_files reference"
      pattern: "docker-compose\\.claude\\.yaml"
    - from: "install.yaml"
      to: "claude/Dockerfile.claude"
      via: "project_files reference"
      pattern: "Dockerfile\\.claude"
---

<objective>
Create DDEV addon skeleton with a dedicated claude container for isolated development with firewall capabilities.

Purpose: The claude container is the primary development environment where both user and Claude work together. It needs all development tooling (git, composer, npm, node, php) plus firewall tools (iptables, ipset). The web container remains completely untouched - it just serves the website.

Output: A functional DDEV addon that creates a dedicated claude container with proper capabilities, mounts, and tooling installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-firewall-foundation/01-RESEARCH.md
@.planning/phases/01-firewall-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DDEV addon manifest (install.yaml)</name>
  <files>install.yaml</files>
  <action>
Update `install.yaml` at project root with:

1. Name: `ddev-claude`
2. Version constraint: `'>= v1.24.10'` (required for proper build context support)
3. Pre-install action: Validate Docker supports NET_ADMIN capability using:
   ```bash
   docker run --rm --cap-add=NET_ADMIN alpine sh -c 'exit 0'
   ```
   Fail with clear error message if capability not supported.

4. Project files to install:
   - `claude/` directory (contains Dockerfile and scripts)
   - `docker-compose.claude.yaml`

5. Post-install action: Make firewall scripts executable:
   ```bash
   chmod +x .ddev/claude/*.sh
   ```

6. Removal actions (idempotent):
   - Remove installed files: `rm -rf .ddev/claude .ddev/docker-compose.claude.yaml`
   - Note: iptables cleanup not needed - container removal destroys rules

Use `#ddev-description:` comments for each action so DDEV shows progress to user.
  </action>
  <verify>
Run `cat install.yaml` and verify:
- `ddev_version_constraint` is set to '>= v1.24.10'
- `project_files` lists `claude/` and `docker-compose.claude.yaml`
- `pre_install_actions`, `post_install_actions`, and `removal_actions` are present
  </verify>
  <done>install.yaml exists with version constraint >= v1.24.10, project files list, and idempotent removal actions</done>
</task>

<task type="auto">
  <name>Task 2: Create Dockerfile for claude container</name>
  <files>claude/Dockerfile.claude</files>
  <action>
Create `claude/Dockerfile.claude` with a full development environment plus firewall tools.

**Base image:** Use debian:bookworm-slim as base (same as DDEV web container OS)

**Install development tools:**
- git (version control)
- curl, wget (downloads)
- php-cli, php-mbstring, php-xml, php-curl (PHP development)
- composer (PHP package manager)
- nodejs, npm (JavaScript tooling)
- unzip (extraction)

**Install firewall tools:**
- iptables (provides iptables-nft on Debian 12)
- ipset (for IP address set management)
- dnsutils (provides dig for DNS resolution)
- netcat-openbsd (provides nc for healthcheck tests)

**Install Claude CLI:**
- Download and install Claude CLI using npm: `npm install -g @anthropic-ai/claude-code`

**Configure container:**
- Set working directory to /var/www/html
- Run as root (required for iptables - DDEV web container runs as non-root, but claude container needs root)

**Dockerfile structure:**
```dockerfile
FROM debian:bookworm-slim

# Install system packages in single layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Development tools
    git \
    curl \
    wget \
    unzip \
    ca-certificates \
    gnupg \
    # PHP
    php-cli \
    php-mbstring \
    php-xml \
    php-curl \
    php-zip \
    # Firewall tools
    iptables \
    ipset \
    dnsutils \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js (LTS) from NodeSource
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Install Claude CLI
RUN npm install -g @anthropic-ai/claude-code

# Set working directory
WORKDIR /var/www/html

# Default command (will be overridden by entrypoint)
CMD ["tail", "-f", "/dev/null"]
```

The `--no-install-recommends` keeps image size small.
The `rm -rf /var/lib/apt/lists/*` cleans apt cache.
  </action>
  <verify>
Run `cat claude/Dockerfile.claude` and verify:
- FROM debian:bookworm-slim
- Installs git, curl, php-cli, nodejs
- Installs iptables, ipset, dnsutils, netcat-openbsd
- Installs composer and claude CLI
- WORKDIR is /var/www/html
  </verify>
  <done>Dockerfile.claude creates development container with git, php, node, composer, claude CLI, and firewall tools</done>
</task>

<task type="auto">
  <name>Task 3: Create docker-compose for claude service</name>
  <files>claude/docker-compose.claude.yaml</files>
  <action>
Create `claude/docker-compose.claude.yaml` defining the claude service.

**Key configuration:**

1. Service name: `claude`
2. Build context: `.ddev/claude` with Dockerfile.claude
3. Add capabilities:
   - NET_ADMIN (required for iptables rule modification)
   - NET_RAW (required for raw socket operations)

4. Override ENTRYPOINT to run firewall setup first:
   ```yaml
   entrypoint: ["/var/www/html/.ddev/claude/entrypoint.sh"]
   command: ["tail", "-f", "/dev/null"]
   ```
   This chains: our firewall script -> keep container running

5. Mount volumes:
   - Project files: same as web container mounts (use DDEV_APPROOT)
   - User's Claude config: `~/.claude:/home/.claude:rw` (read-write so Claude can update settings)

6. Network: Connect to DDEV's default network (ddev_default)

7. Healthcheck configuration:
   ```yaml
   healthcheck:
     test: ["CMD-SHELL", "/var/www/html/.ddev/claude/healthcheck.sh"]
     interval: 30s
     timeout: 5s
     retries: 3
     start_period: 15s
   ```

8. Labels for DDEV integration:
   - `com.ddev.site-name: ${DDEV_SITENAME}`
   - `com.ddev.approot: ${DDEV_APPROOT}`

**docker-compose structure:**
```yaml
services:
  claude:
    build:
      context: .ddev/claude
      dockerfile: Dockerfile.claude
    container_name: ddev-${DDEV_SITENAME}-claude

    cap_add:
      - NET_ADMIN
      - NET_RAW

    entrypoint: ["/var/www/html/.ddev/claude/entrypoint.sh"]
    command: ["tail", "-f", "/dev/null"]

    volumes:
      - type: bind
        source: .
        target: /var/www/html
        consistency: cached
      - ~/.claude:/home/.claude:rw

    working_dir: /var/www/html

    networks:
      - default

    healthcheck:
      test: ["CMD-SHELL", "/var/www/html/.ddev/claude/healthcheck.sh"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    labels:
      com.ddev.site-name: ${DDEV_SITENAME}
      com.ddev.approot: ${DDEV_APPROOT}

networks:
  default:
    name: ddev_default
    external: true
```

Do NOT add version key - DDEV handles compose version automatically.
  </action>
  <verify>
Run `cat claude/docker-compose.claude.yaml` and verify:
- Service name is `claude`
- `cap_add` includes NET_ADMIN and NET_RAW
- `entrypoint` points to `/var/www/html/.ddev/claude/entrypoint.sh`
- `volumes` mounts project files and `~/.claude`
- `healthcheck` block exists with test command
- Uses `ddev_default` network
  </verify>
  <done>docker-compose.claude.yaml defines claude service with NET_ADMIN/NET_RAW capabilities, project mounts, ~/.claude mount, and healthcheck</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify file structure exists:
   ```bash
   ls -la install.yaml claude/Dockerfile.claude claude/docker-compose.claude.yaml
   ```

2. Validate YAML syntax:
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('install.yaml'))"
   python3 -c "import yaml; yaml.safe_load(open('claude/docker-compose.claude.yaml'))"
   ```

3. Verify key patterns in files:
   ```bash
   grep -q "ddev_version_constraint" install.yaml
   grep -q "NET_ADMIN" claude/docker-compose.claude.yaml
   grep -q "iptables" claude/Dockerfile.claude
   grep -q "claude" claude/docker-compose.claude.yaml
   ```

4. Verify Dockerfile syntax:
   ```bash
   docker build --help >/dev/null 2>&1 && echo "Docker available"
   ```
</verification>

<success_criteria>
- install.yaml exists with DDEV v1.24.10+ version constraint
- claude/Dockerfile.claude builds container with dev tools + firewall tools
- claude/docker-compose.claude.yaml defines dedicated claude service
- docker-compose.claude.yaml grants NET_ADMIN and NET_RAW capabilities
- docker-compose.claude.yaml mounts project files at /var/www/html
- docker-compose.claude.yaml mounts ~/.claude to /home/.claude (DDEV-04)
- All YAML files have valid syntax
- Web container is NOT modified (no .ddev/web-build, no docker-compose.firewall.yaml)
</success_criteria>

<output>
After completion, create `.planning/phases/01-firewall-foundation/01-01-SUMMARY.md`
</output>
