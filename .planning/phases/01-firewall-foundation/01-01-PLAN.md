---
phase: 01-firewall-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - install.yaml
  - .ddev/docker-compose.firewall.yaml
  - .ddev/web-build/Dockerfile.firewall
autonomous: true

must_haves:
  truths:
    - "DDEV addon can be installed via `ddev get` without errors"
    - "Web container has NET_ADMIN and NET_RAW capabilities after installation"
    - "iptables and ipset commands are available in the web container"
    - "User's ~/.claude config directory is mounted into web container"
  artifacts:
    - path: "install.yaml"
      provides: "DDEV addon manifest"
      contains: "ddev_version_constraint"
    - path: ".ddev/docker-compose.firewall.yaml"
      provides: "Capability grants, ENTRYPOINT override, and Claude config mount"
      contains: "NET_ADMIN"
    - path: ".ddev/web-build/Dockerfile.firewall"
      provides: "Web container extension with firewall tools"
      contains: "iptables"
  key_links:
    - from: "install.yaml"
      to: ".ddev/docker-compose.firewall.yaml"
      via: "project_files reference"
      pattern: "docker-compose\\.firewall\\.yaml"
    - from: "install.yaml"
      to: ".ddev/web-build/Dockerfile.firewall"
      via: "project_files reference"
      pattern: "Dockerfile\\.firewall"
---

<objective>
Create DDEV addon skeleton with capability grants and firewall tooling installed.

Purpose: Establish the foundation for the firewall - the addon structure, Docker capabilities for iptables manipulation, and the necessary packages installed in the web container.

Output: A minimal but functional DDEV addon that can be installed, grants NET_ADMIN/NET_RAW capabilities, and has iptables/ipset available.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-firewall-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DDEV addon manifest (install.yaml)</name>
  <files>install.yaml</files>
  <action>
Create `install.yaml` at project root with:

1. Name: `ddev-claude`
2. Version constraint: `'>= v1.24.10'` (required for proper build context support)
3. Pre-install action: Validate Docker supports NET_ADMIN capability using:
   ```bash
   docker run --rm --cap-add=NET_ADMIN alpine sh -c 'exit 0'
   ```
   Fail with clear error message if capability not supported.

4. Project files to install:
   - `firewall/` directory
   - `web-build/Dockerfile.firewall`
   - `docker-compose.firewall.yaml`

5. Post-install action: Make firewall scripts executable:
   ```bash
   chmod +x .ddev/firewall/*.sh
   ```

6. Removal actions (idempotent):
   - Try to flush iptables rules if container running: `ddev exec iptables -F OUTPUT 2>/dev/null || true`
   - Reset OUTPUT policy: `ddev exec iptables -P OUTPUT ACCEPT 2>/dev/null || true`
   - Destroy ipset: `ddev exec ipset destroy whitelist_ips 2>/dev/null || true`
   - Remove installed files: `rm -rf .ddev/firewall .ddev/web-build/Dockerfile.firewall .ddev/docker-compose.firewall.yaml`

Use `#ddev-description:` comments for each action so DDEV shows progress to user.
  </action>
  <verify>
Run `cat install.yaml` and verify:
- `ddev_version_constraint` is set
- `project_files` lists all three items
- `pre_install_actions`, `post_install_actions`, and `removal_actions` are present
  </verify>
  <done>install.yaml exists with version constraint >= v1.24.10, project files list, and idempotent removal actions</done>
</task>

<task type="auto">
  <name>Task 2: Create docker-compose capability grant</name>
  <files>.ddev/docker-compose.firewall.yaml</files>
  <action>
Create `.ddev/docker-compose.firewall.yaml` with:

1. Services section for `web` container
2. Add capabilities:
   - NET_ADMIN (required for iptables rule modification)
   - NET_RAW (required for raw socket operations)

3. Override ENTRYPOINT to run firewall setup first:
   ```yaml
   entrypoint: ["/var/www/html/.ddev/firewall/entrypoint.sh"]
   command: ["/docker-entrypoint.sh"]
   ```
   This chains: our script -> original DDEV entrypoint

4. Add healthcheck configuration:
   ```yaml
   healthcheck:
     test: ["CMD-SHELL", "/var/www/html/.ddev/firewall/healthcheck.sh"]
     interval: 30s
     timeout: 5s
     retries: 3
     start_period: 15s
   ```

5. Mount user's Claude config directory (DDEV-04 requirement):
   ```yaml
   volumes:
     - ~/.claude:/home/.claude:ro
   ```
   This makes Claude CLI settings available inside the container (read-only for safety).

Do NOT add version key - DDEV handles compose version automatically.
  </action>
  <verify>
Run `cat .ddev/docker-compose.firewall.yaml` and verify:
- `cap_add` includes NET_ADMIN and NET_RAW
- `entrypoint` points to `/var/www/html/.ddev/firewall/entrypoint.sh`
- `command` chains to `/docker-entrypoint.sh`
- `healthcheck` block exists with test command
- `volumes` mounts `~/.claude` to `/home/.claude`
  </verify>
  <done>docker-compose.firewall.yaml grants NET_ADMIN/NET_RAW, overrides ENTRYPOINT, configures healthcheck, and mounts ~/.claude config</done>
</task>

<task type="auto">
  <name>Task 3: Create Dockerfile extending web container</name>
  <files>.ddev/web-build/Dockerfile.firewall</files>
  <action>
Create `.ddev/web-build/Dockerfile.firewall` with:

1. Base: Use ARG for BASE_IMAGE (DDEV convention)
2. Install packages:
   - iptables (provides iptables-nft on Debian 12)
   - ipset (for IP address set management)
   - dnsutils (provides dig for DNS resolution)
   - netcat-openbsd (provides nc for healthcheck tests)

Use single RUN command to minimize layers:
```dockerfile
ARG BASE_IMAGE
FROM $BASE_IMAGE

RUN apt-get update && apt-get install -y --no-install-recommends \
    iptables \
    ipset \
    dnsutils \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*
```

The `--no-install-recommends` keeps image size small.
The `rm -rf /var/lib/apt/lists/*` cleans apt cache.
  </action>
  <verify>
Run `cat .ddev/web-build/Dockerfile.firewall` and verify:
- Uses ARG BASE_IMAGE pattern
- Installs iptables, ipset, dnsutils, netcat-openbsd
- Cleans up apt cache
  </verify>
  <done>Dockerfile.firewall installs iptables, ipset, dnsutils, and netcat-openbsd on DDEV web container base</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify file structure exists:
   ```bash
   ls -la install.yaml .ddev/docker-compose.firewall.yaml .ddev/web-build/Dockerfile.firewall
   ```

2. Validate YAML syntax:
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('install.yaml'))"
   python3 -c "import yaml; yaml.safe_load(open('.ddev/docker-compose.firewall.yaml'))"
   ```

3. Verify key patterns in files:
   ```bash
   grep -q "ddev_version_constraint" install.yaml
   grep -q "NET_ADMIN" .ddev/docker-compose.firewall.yaml
   grep -q "iptables" .ddev/web-build/Dockerfile.firewall
   ```
</verification>

<success_criteria>
- install.yaml exists with DDEV v1.24.10+ version constraint
- docker-compose.firewall.yaml grants NET_ADMIN and NET_RAW capabilities
- docker-compose.firewall.yaml overrides ENTRYPOINT to run firewall setup
- docker-compose.firewall.yaml mounts ~/.claude to /home/.claude (DDEV-04)
- Dockerfile.firewall installs iptables, ipset, dnsutils, netcat-openbsd
- All YAML files have valid syntax
</success_criteria>

<output>
After completion, create `.planning/phases/01-firewall-foundation/01-01-SUMMARY.md`
</output>
