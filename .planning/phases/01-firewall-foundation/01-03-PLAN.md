---
phase: 01-firewall-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - claude/healthcheck.sh
autonomous: true

must_haves:
  truths:
    - "Healthcheck verifies iptables rules are loaded"
    - "Healthcheck verifies ipset exists with entries"
    - "Healthcheck verifies blocking is working (test blocked connection)"
    - "Container shows unhealthy status in `ddev status` if firewall fails"
    - "Blocked requests are logged with FIREWALL-BLOCK prefix for later parsing"
  artifacts:
    - path: "claude/healthcheck.sh"
      provides: "Docker healthcheck script for firewall validation"
      contains: "iptables -L OUTPUT"
  key_links:
    - from: "claude/docker-compose.claude.yaml"
      to: "claude/healthcheck.sh"
      via: "healthcheck test command"
      pattern: "healthcheck\\.sh"
    - from: "claude/entrypoint.sh"
      to: "kernel log"
      via: "iptables LOG rule"
      pattern: "FIREWALL-BLOCK"
---

<objective>
Implement healthcheck validation to ensure firewall is functioning correctly.

Purpose: Ensure the firewall is working correctly (not just that scripts ran) and validate that blocking actually works. The healthcheck provides visibility into firewall state through `ddev status`.

Output: A healthcheck that validates firewall state and confirms blocking is active.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-firewall-foundation/01-RESEARCH.md
@.planning/phases/01-firewall-foundation/01-CONTEXT.md
@.planning/phases/01-firewall-foundation/01-01-SUMMARY.md
@.planning/phases/01-firewall-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create healthcheck validation script</name>
  <files>claude/healthcheck.sh</files>
  <action>
Create `claude/healthcheck.sh` to validate firewall is functioning correctly.

**Validation checks (all must pass):**

1. **Verify iptables rules exist:**
   - Check OUTPUT chain has rules loaded
   - Count rules: should be at least 5 (loopback, DNS x2, established, whitelist, log)
   - Fail if too few rules (firewall didn't initialize properly)

2. **Verify OUTPUT policy is DROP:**
   - `iptables -L OUTPUT | head -1` should show `(policy DROP)`
   - If policy is ACCEPT, firewall is not protecting

3. **Verify ipset exists:**
   - `ipset list whitelist_ips` should succeed
   - If ipset doesn't exist, whitelisting won't work

4. **Verify ipset has entries:**
   - Count entries in whitelist_ips
   - Warn (but don't fail) if empty - might be legitimate if no domains configured

5. **Verify blocking works (functional test):**
   - Try to connect to a definitely-blocked IP (e.g., 198.51.100.1 - TEST-NET-2, never routable)
   - Use `timeout 2 nc -zv 198.51.100.1 80 2>&1`
   - If connection succeeds, firewall is NOT blocking - FAIL
   - If connection times out or refused, firewall IS blocking - PASS

**Exit codes:**
- 0: Healthcheck passed, firewall is working
- 1: Healthcheck failed, firewall is broken

**Output format:**
- Log each check with PASS/FAIL
- Final line: "Firewall healthcheck passed" or "Firewall healthcheck FAILED: <reason>"

**Script structure:**
```bash
#!/bin/bash
set -e

LOG_PREFIX="[ddev-claude-healthcheck]"
log() { echo "$LOG_PREFIX $*"; }
fail() { echo "$LOG_PREFIX FAILED: $*" >&2; exit 1; }

# Check 1: iptables rules exist
rule_count=$(iptables -L OUTPUT -n 2>/dev/null | grep -c "^[A-Z]" || echo 0)
if [[ $rule_count -lt 5 ]]; then
  fail "Too few iptables rules ($rule_count), firewall not initialized"
fi
log "PASS: iptables rules loaded ($rule_count rules)"

# Check 2: OUTPUT policy is DROP
policy=$(iptables -L OUTPUT 2>/dev/null | head -1 | grep -o "policy [A-Z]*" || echo "policy UNKNOWN")
if [[ "$policy" != "policy DROP" ]]; then
  fail "OUTPUT policy is not DROP ($policy)"
fi
log "PASS: OUTPUT policy is DROP"

# Check 3: ipset exists
if ! ipset list whitelist_ips &>/dev/null; then
  fail "ipset 'whitelist_ips' not found"
fi
log "PASS: ipset 'whitelist_ips' exists"

# Check 4: ipset has entries (warn only)
entry_count=$(ipset list whitelist_ips 2>/dev/null | grep -c "^[0-9]" || echo 0)
if [[ $entry_count -eq 0 ]]; then
  log "WARN: ipset 'whitelist_ips' is empty (no domains whitelisted)"
else
  log "PASS: ipset has $entry_count IPs whitelisted"
fi

# Check 5: blocking works (functional test)
# Use TEST-NET-2 (198.51.100.0/24) - reserved, never routable
if timeout 2 nc -zv 198.51.100.1 80 2>&1 | grep -q "succeeded\|open"; then
  fail "Firewall not blocking - 198.51.100.1:80 was accessible"
fi
log "PASS: Firewall is blocking non-whitelisted traffic"

log "Firewall healthcheck passed"
exit 0
```
  </action>
  <verify>
Run checks:
```bash
# Script exists and is shell
head -1 claude/healthcheck.sh | grep -q "#!/bin/bash"

# Key validation patterns present
grep -q "iptables -L OUTPUT" claude/healthcheck.sh
grep -q "policy DROP" claude/healthcheck.sh
grep -q "ipset list whitelist_ips" claude/healthcheck.sh
grep -q "timeout" claude/healthcheck.sh
grep -q "exit 0" claude/healthcheck.sh
grep -q "exit 1" claude/healthcheck.sh

# Syntax check
bash -n claude/healthcheck.sh
```
  </verify>
  <done>healthcheck.sh validates iptables rules, DROP policy, ipset existence, and functional blocking test</done>
</task>

<task type="auto">
  <name>Task 2: Verify all files are in place and executable</name>
  <files>claude/entrypoint.sh, claude/resolve-and-apply.sh, claude/healthcheck.sh</files>
  <action>
Ensure all scripts in the claude/ directory are properly set up:

1. **Verify file structure is complete:**
   - claude/Dockerfile.claude (from Plan 01)
   - claude/docker-compose.claude.yaml (from Plan 01)
   - claude/entrypoint.sh (from Plan 02)
   - claude/resolve-and-apply.sh (from Plan 02)
   - claude/whitelist-domains.txt (from Plan 02)
   - claude/healthcheck.sh (from this plan)

2. **Make all shell scripts executable:**
   ```bash
   chmod +x claude/*.sh
   ```

3. **Validate all YAML files:**
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('install.yaml'))"
   python3 -c "import yaml; yaml.safe_load(open('claude/docker-compose.claude.yaml'))"
   ```

4. **Validate all shell scripts:**
   ```bash
   bash -n claude/entrypoint.sh
   bash -n claude/resolve-and-apply.sh
   bash -n claude/healthcheck.sh
   ```

This task ensures the addon is ready for installation testing.
  </action>
  <verify>
Run comprehensive checks:
```bash
# All files exist
ls -la claude/

# All scripts executable
test -x claude/entrypoint.sh || echo "entrypoint.sh not executable"
test -x claude/resolve-and-apply.sh || echo "resolve-and-apply.sh not executable"
test -x claude/healthcheck.sh || echo "healthcheck.sh not executable"

# All scripts valid
bash -n claude/entrypoint.sh && echo "entrypoint.sh valid"
bash -n claude/resolve-and-apply.sh && echo "resolve-and-apply.sh valid"
bash -n claude/healthcheck.sh && echo "healthcheck.sh valid"

# YAML valid
python3 -c "import yaml; yaml.safe_load(open('install.yaml'))" && echo "install.yaml valid"
python3 -c "import yaml; yaml.safe_load(open('claude/docker-compose.claude.yaml'))" && echo "docker-compose.claude.yaml valid"
```
  </verify>
  <done>All addon files exist, shell scripts are executable and pass syntax validation, YAML files are valid</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify healthcheck script:
   ```bash
   # Exists and is shell
   test -f claude/healthcheck.sh
   bash -n claude/healthcheck.sh

   # Contains all validation checks
   grep -c "PASS:" claude/healthcheck.sh  # Should be 4-5
   grep -c "fail\|FAILED" claude/healthcheck.sh  # Should be >= 3
   ```

2. Verify complete file structure:
   ```bash
   ls -la claude/
   # Should show: Dockerfile.claude, docker-compose.claude.yaml, entrypoint.sh,
   # resolve-and-apply.sh, whitelist-domains.txt, healthcheck.sh
   ```

3. Verify docker-compose references healthcheck:
   ```bash
   grep -q "healthcheck.sh" claude/docker-compose.claude.yaml
   ```

4. Verify all scripts are executable:
   ```bash
   ls -la claude/*.sh | grep -E "^-rwx"
   ```
</verification>

<success_criteria>
- healthcheck.sh validates: iptables rules loaded, DROP policy set, ipset exists, blocking works
- healthcheck.sh exits 0 on pass, 1 on fail
- All shell scripts in claude/ are executable
- All YAML files pass syntax validation
- Complete file structure in place for DDEV addon
</success_criteria>

<output>
After completion, create `.planning/phases/01-firewall-foundation/01-03-SUMMARY.md`
</output>
